<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Signup</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./style.css" />
    <link rel="stylesheet" href="./studentsignup.css" />
  </head>
  <body>
    <div class="container">
      <div class="login-left">
        <h1>Create Admin Account</h1>
        <p class="subtitle">
          Join us as an administrator and manage the system.
        </p>

        <form id="signupForm" onsubmit="return false;">
          <!-- Step 1: Email Input -->
          <div id="emailSection">
            <input
              type="email"
              id="email"
              name="email"
              placeholder="Enter your admin email"
              required
            />
            <button type="button" id="sendOtpBtn">Send OTP</button>
          </div>

          <!-- Step 2: OTP Verification -->
          <div id="otpSection" style="display: none">
            <input
              type="text"
              id="otp"
              name="otp"
              placeholder="Enter OTP"
              required
            />
            <button type="button" id="verifyOtpBtn">Verify OTP</button>
          </div>

          <!-- Step 3: Registration Details -->
          <div id="registerSection" style="display: none">
            <input
              type="text"
              id="name"
              name="name"
              placeholder="Full Name"
              required
            />
            <input
              type="password"
              id="password"
              name="password"
              placeholder="Password"
              required
            />
            <input
              type="password"
              id="confirm-password"
              name="confirmPassword"
              placeholder="Confirm Password"
              required
            />
            <button type="button" id="signupBtn">Create Admin Account</button>
          </div>

          <div class="error-message" id="errorMessage"></div>
          <div class="success-message" id="successMessage"></div>
          <p class="alt-link">
            Already have an account? <a href="./admin-login.html">Log in</a>
          </p>
        </form>
      </div>

      <div class="login-right">
        <img
          src="./img/admin portal.png"
          alt="Admin Signup Illustration"
        />
      </div>
    </div>

    <script>
      // --- DOM Elements ---
      const emailSection = document.getElementById("emailSection");
      const otpSection = document.getElementById("otpSection");
      const registerSection = document.getElementById("registerSection");

      const emailInput = document.getElementById("email");
      const otpInput = document.getElementById("otp");

      const sendOtpBtn = document.getElementById("sendOtpBtn");
      const verifyOtpBtn = document.getElementById("verifyOtpBtn");
      const signupBtn = document.getElementById("signupBtn");

      const errorMessage = document.getElementById("errorMessage");
      const successMessage = document.getElementById("successMessage");

      let verifiedEmail = null;

      // --- Event Listeners ---
      sendOtpBtn.onclick = async function () {
        const email = emailInput.value;
        if (!email) {
          errorMessage.textContent = "Please enter an email address.";
          return;
        }
        successMessage.textContent = "Sending OTP...";
        errorMessage.textContent = "";
        
        try {
          const res = await fetch("/api/send-otp", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, role: 'admin' }),
          });
          const data = await res.json();
          if (data.success) {
            successMessage.textContent = data.message || "OTP sent to your email!";
            emailSection.style.display = "none";
            otpSection.style.display = "block";
          } else {
            errorMessage.textContent = data.message || "Failed to send OTP.";
            successMessage.textContent = "";
          }
        } catch (error) {
          errorMessage.textContent = "Network error. Please try again.";
          successMessage.textContent = "";
        }
      };

      verifyOtpBtn.onclick = async function () {
        const email = emailInput.value;
        const otp = otpInput.value;
        if (!otp) {
          errorMessage.textContent = "Please enter the OTP.";
          return;
        }
        successMessage.textContent = "Verifying OTP...";
        errorMessage.textContent = "";
        
        try {
          const res = await fetch("/api/verify-otp", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, otp }),
          });
          const data = await res.json();
          if (data.success) {
            verifiedEmail = email;
            successMessage.textContent = "OTP Verified! Please complete your registration.";
            otpSection.style.display = "none";
            registerSection.style.display = "block";
          } else {
            errorMessage.textContent = data.message || "Invalid or expired OTP.";
            successMessage.textContent = "";
          }
        } catch (error) {
          errorMessage.textContent = "Network error. Please try again.";
          successMessage.textContent = "";
        }
      };

      signupBtn.onclick = async function () {
        const name = document.getElementById("name").value;
        const password = document.getElementById("password").value;
        const confirmPassword = document.getElementById("confirm-password").value;
        
        if (!verifiedEmail) {
          errorMessage.textContent = "Email not verified. Please start over.";
          return;
        }
        if (password !== confirmPassword) {
          errorMessage.textContent = "Passwords do not match.";
          return;
        }
        if (!name || !password) {
          errorMessage.textContent = "Name and password are required.";
          return;
        }

        signupBtn.disabled = true;
        errorMessage.textContent = "";
        successMessage.textContent = "Creating admin account...";

        try {
          const res = await fetch("/api/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
              name, 
              email: verifiedEmail, 
              password, 
              confirmPassword: password,
              role: 'admin'
            }),
          });
          
          const data = await res.json();
          
          if (data.success) {
            successMessage.textContent = "Admin Account Created Successfully! Redirecting to login...";
            setTimeout(() => {
              window.location.href = "./admin-login.html";
            }, 2000);
          } else {
            errorMessage.textContent = data.message || "Registration failed.";
            successMessage.textContent = "";
            signupBtn.disabled = false;
          }
        } catch (error) {
          errorMessage.textContent = "Network error. Please try again.";
          successMessage.textContent = "";
          signupBtn.disabled = false;
        }
      };
    </script>
  </body>
</html>