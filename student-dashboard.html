<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard - Roland Institute of Technology</title>
    <link rel="stylesheet" href="./student-dashboard.css" />
    <link rel="stylesheet" href="./style.css" />
    <link rel="stylesheet" href="./messages.css" />
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Header -->
      <header class="dashboard-header">
        <div class="header-left">
          <img src="./img/rit logo.png" alt="RIT Logo" class="logo" />
          <h1>Student Dashboard</h1>
        </div>
        <div class="header-right">
          <div class="user-info">
            <span id="userName">Loading...</span>
            <span id="userEmail">Loading...</span>
          </div>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </header>

      <!-- Navigation -->
      <nav class="dashboard-nav">
        <a href="#overview" class="nav-item active" data-section="overview">
          <span class="nav-icon">üìä</span>
          Overview
        </a>
        <a href="#attendance" class="nav-item" data-section="attendance">
          <span class="nav-icon">üìÖ</span>
          Attendance
        </a>
        <a href="#results" class="nav-item" data-section="results">
          <span class="nav-icon">üìà</span>
          Results
        </a>
        <a href="#assignments" class="nav-item" data-section="assignments">
          <span class="nav-icon">üìù</span>
          Assignments
        </a>
        <a href="#notices" class="nav-item" data-section="notices">
          <span class="nav-icon">üì¢</span>
          Notices
        </a>
        <a href="#profile" class="nav-item" data-section="profile">
          <span class="nav-icon">üë§</span>
          Profile
        </a>
      </nav>

      <!-- Main Content -->
      <main class="dashboard-main">
        <!-- Overview Section -->
        <section id="overview" class="dashboard-section active">
          <h2>Welcome to Your Dashboard</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon">üìä</div>
              <div class="stat-content">
                <h3>Overall Attendance</h3>
                <p class="stat-value" id="attendancePercentage">85%</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üìà</div>
              <div class="stat-content">
                <h3>Average Grade</h3>
                <p class="stat-value" id="averageGrade">A-</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üìù</div>
              <div class="stat-content">
                <h3>Pending Assignments</h3>
                <p class="stat-value" id="pendingAssignments">3</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon">üì¢</div>
              <div class="stat-content">
                <h3>Unread Notices</h3>
                <p class="stat-value" id="unreadNotices">2</p>
              </div>
            </div>
          </div>

          <div class="quick-actions">
            <h3>Quick Actions</h3>
            <div class="action-buttons">
              <button class="action-btn" onclick="markAttendance()">
                <span class="btn-icon">‚úÖ</span>
                Mark Attendance
              </button>
              <button class="action-btn" onclick="viewResults()">
                <span class="btn-icon">üìä</span>
                View Results
              </button>
              <button class="action-btn" onclick="submitAssignment()">
                <span class="btn-icon">üì§</span>
                Submit Assignment
              </button>
              <button class="action-btn" onclick="updateProfile()">
                <span class="btn-icon">‚úèÔ∏è</span>
                Update Profile
              </button>
            </div>
          </div>

          <div class="recent-activity">
            <h3>Recent Activity</h3>
            <div class="activity-list" id="recentActivity">
              <div class="activity-item">
                <span class="activity-icon">üìÖ</span>
                <div class="activity-content">
                  <p>Attendance marked for Data Structures</p>
                  <span class="activity-time">2 hours ago</span>
                </div>
              </div>
              <div class="activity-item">
                <span class="activity-icon">üìù</span>
                <div class="activity-content">
                  <p>Assignment submitted: Web Development Project</p>
                  <span class="activity-time">1 day ago</span>
                </div>
              </div>
              <div class="activity-item">
                <span class="activity-icon">üì¢</span>
                <div class="activity-content">
                  <p>New notice: Mid-term exam schedule</p>
                  <span class="activity-time">2 days ago</span>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Attendance Section -->
        <section id="attendance" class="dashboard-section">
          <h2>Attendance Records</h2>
          <div class="attendance-summary">
            <div class="summary-card">
              <h3>This Month</h3>
              <p class="summary-value">92%</p>
            </div>
            <div class="summary-card">
              <h3>Total Classes</h3>
              <p class="summary-value">45</p>
            </div>
            <div class="summary-card">
              <h3>Present</h3>
              <p class="summary-value">41</p>
            </div>
            <div class="summary-card">
              <h3>Absent</h3>
              <p class="summary-value">4</p>
            </div>
          </div>
          <div class="attendance-table">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Subject</th>
                  <th>Status</th>
                  <th>Professor</th>
                </tr>
              </thead>
              <tbody id="attendanceTableBody">
                <!-- Attendance records will be loaded here -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- Results Section -->
        <section id="results" class="dashboard-section">
          <h2>Academic Results</h2>
          <div class="results-grid" id="resultsGrid">
            <!-- Results will be loaded here -->
          </div>
        </section>

        <!-- Assignments Section -->
        <section id="assignments" class="dashboard-section">
          <h2>Assignments</h2>
          <div class="assignments-list" id="assignmentsList">
            <!-- Assignments will be loaded here -->
          </div>
        </section>

        <!-- Notices Section -->
        <section id="notices" class="dashboard-section">
          <h2>Notices & Announcements</h2>
          <div class="notices-list" id="noticesList">
            <!-- Notices will be loaded here -->
          </div>
        </section>

         <!-- Profile Section -->
         <section id="profile" class="dashboard-section">
           <h2>Profile Information</h2>
           
           <!-- Profile Completion Form -->
           <div id="profileForm" class="profile-form-container" style="display: none;">
             <div class="form-progress">
               <div class="progress-steps">
                 <div class="step active" data-step="1">
                   <div class="step-icon">üë§</div>
                   <span>Personal Info</span>
                 </div>
                 <div class="step" data-step="2">
                   <div class="step-icon">üéì</div>
                   <span>Academic Info</span>
                 </div>
                 <div class="step" data-step="3">
                   <div class="step-icon">üíº</div>
                   <span>Professional Info</span>
                 </div>
               </div>
             </div>

             <form id="multiStepForm" enctype="multipart/form-data">
               <!-- Step 1: Personal Information -->
               <div class="form-step active" data-step="1">
                 <h3>Personal Information</h3>
                 <div class="form-grid">
                   <div class="form-group">
                     <label for="fullName">Full Name *</label>
                     <input type="text" id="fullName" name="fullName" required>
                   </div>
                   <div class="form-group">
                     <label for="age">Age *</label>
                     <input type="number" id="age" name="age" min="16" max="50" required>
                   </div>
                   <div class="form-group">
                     <label for="gender">Gender *</label>
                     <select id="gender" name="gender" required>
                       <option value="">Select Gender</option>
                       <option value="Male">Male</option>
                       <option value="Female">Female</option>
                       <option value="Other">Other</option>
                     </select>
                   </div>
                   <div class="form-group">
                     <label for="email">Email *</label>
                     <input type="email" id="email" name="email" readonly>
                   </div>
                   <div class="form-group">
                     <label for="phone">Phone Number *</label>
                     <input type="tel" id="phone" name="phone" required>
                   </div>
                   <div class="form-group">
                     <label for="whatsapp">WhatsApp Number *</label>
                     <input type="tel" id="whatsapp" name="whatsapp" required>
                   </div>
                   <div class="form-group full-width">
                     <label for="profilePicture">Profile Picture</label>
                     <input type="file" id="profilePicture" name="profilePicture" accept="image/*">
                     <small>JPG/PNG, max 500KB</small>
                   </div>
                 </div>
               </div>

               <!-- Step 2: Academic Information -->
               <div class="form-step" data-step="2">
                 <h3>Academic Information</h3>
                 <div class="form-grid">
                   <div class="form-group">
                     <label for="registrationNo">Registration Number *</label>
                     <input type="text" id="registrationNo" name="registrationNo" required>
                   </div>
                   <div class="form-group">
                     <label for="branch">Branch *</label>
                     <select id="branch" name="branch" required>
                       <option value="">Select Branch</option>
                       <option value="CSE">Computer Science Engineering (CSE)</option>
                       <option value="ME">Mechanical Engineering (ME)</option>
                       <option value="ECE">Electronics & Communication Engineering (ECE)</option>
                       <option value="EE">Electrical Engineering (EE)</option>
                       <option value="Civil">Civil Engineering</option>
                     </select>
                   </div>
                   <div class="form-group">
                     <label for="yearOfStudy">Year of Study *</label>
                     <select id="yearOfStudy" name="yearOfStudy" required>
                       <option value="">Select Year</option>
                       <option value="1">1st Year</option>
                       <option value="2">2nd Year</option>
                       <option value="3">3rd Year</option>
                       <option value="4">4th Year</option>
                     </select>
                   </div>
                   <div class="form-group">
                     <label for="section">Section *</label>
                     <select id="section" name="section" required>
                       <option value="">Select Section</option>
                       <option value="A">Section A</option>
                       <option value="B">Section B</option>
                       <option value="C">Section C</option>
                       <option value="D">Section D</option>
                     </select>
                   </div>
                 </div>
               </div>

               <!-- Step 3: Professional Information -->
               <div class="form-step" data-step="3">
                 <h3>Professional Information (Optional)</h3>
                 <div class="form-grid">
                   <div class="form-group">
                     <label for="role">Choose Your Role</label>
                     <select id="role" name="role">
                       <option value="">Select Role (Optional)</option>
                       <option value="Developer">Developer</option>
                       <option value="Frontend Designer">Frontend Designer</option>
                       <option value="Tester">Tester</option>
                     </select>
                   </div>
                   <div class="form-group full-width">
                     <label for="skills">Skills</label>
                     <textarea id="skills" name="skills" rows="3" placeholder="Enter your skills separated by commas"></textarea>
                   </div>
                   <div class="form-group full-width">
                     <label for="resumeFile">Resume Upload</label>
                     <input type="file" id="resumeFile" name="resumeFile" accept=".pdf">
                     <small>PDF only, max 5MB</small>
                   </div>
                 </div>
               </div>

               <!-- Navigation Buttons -->
               <div class="form-navigation">
                 <button type="button" id="prevBtn" class="nav-btn prev-btn" style="display: none;">
                   <span>‚Üê</span> Previous
                 </button>
                 <button type="button" id="nextBtn" class="nav-btn next-btn">
                   Next <span>‚Üí</span>
                 </button>
                 <button type="submit" id="submitBtn" class="nav-btn submit-btn" style="display: none;">
                   Complete Profile
                 </button>
               </div>
             </form>
           </div>

           <!-- Profile Display -->
           <div id="profileDisplay" class="profile-content">
             <div class="profile-picture">
               <img
                 src="./img/nav profile.png"
                 alt="Profile Picture"
                 id="profileImage"
               />
               <button class="change-photo-btn" onclick="editProfile()">Edit Profile</button>
             </div>
             <div class="profile-details" id="profileDetails">
               <!-- Profile details will be loaded here -->
             </div>
           </div>
         </section>
      </main>
    </div>

    <!-- Success/Error Messages -->
    <div class="message-container">
      <div class="success-message" id="successMessage"></div>
      <div class="error-message" id="errorMessage"></div>
    </div>
<script>
/* ==========================
   DASHBOARD & AUTH
   ========================== */

function checkAuth() {
  const user = localStorage.getItem("user");
  if (!user) {
    window.location.href = "./stu_login.html";
    return null;
  }
  return JSON.parse(user);
}

function initDashboard() {
  const user = checkAuth();
  if (!user) return;

  document.getElementById("userName").textContent = user.name;
  document.getElementById("userEmail").textContent = user.email;

  checkProfileCompletion(user);
}

async function checkProfileCompletion(user) {
  try {
    const response = await fetch(`/api/student/profile-status/${user.id}`);
    const data = await response.json();

    if (data.success) {
      if (!data.isComplete) {
        showProfileCompletionPopup();
        document.getElementById('profileForm').style.display = 'block';
        document.getElementById('profileDisplay').style.display = 'none';
        document.getElementById('email').value = user.email;
      } else {
        loadProfileData(user);
      }
    }
  } catch (error) {
    console.error('Error checking profile status:', error);
    showProfileCompletionPopup();
    document.getElementById('profileForm').style.display = 'block';
    document.getElementById('profileDisplay').style.display = 'none';
    document.getElementById('email').value = user.email;
  }
}

function showProfileCompletionPopup() {
  const popup = document.createElement('div');
  popup.className = 'profile-completion-popup';
  popup.innerHTML = `
    <div class="popup-content">
      <h3>üìã Complete Your Profile</h3>
      <p>To access all dashboard features, please complete your profile information.</p>
      <button onclick="this.parentElement.parentElement.remove()" class="popup-btn">Complete Now</button>
    </div>
  `;
  document.body.appendChild(popup);

  setTimeout(() => {
    if (popup.parentElement) popup.remove();
  }, 5000);
}

function setupNavigation() {
  const navItems = document.querySelectorAll(".nav-item");
  const sections = document.querySelectorAll(".dashboard-section");

  navItems.forEach((item) => {
    item.addEventListener("click", (e) => {
      e.preventDefault();
      navItems.forEach((nav) => nav.classList.remove("active"));
      sections.forEach((section) => section.classList.remove("active"));

      item.classList.add("active");
      const targetSection = item.getAttribute("data-section");
      document.getElementById(targetSection).classList.add("active");
    });
  });
}

function markAttendance() { showMessage("Please scan your QR code using the admin dashboard", "info"); }
function viewResults() { loadStudentResults(); }
function submitAssignment() { loadStudentAssignments(); }
function updateProfile() { document.querySelector('[data-section="profile"]').click(); }

// New functionality
async function loadStudentAttendance() {
  try {
    const user = checkAuth();
    if (!user) return;

    // Get current month dates
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const firstDay = `${year}-${month}-01`;
    const lastDay = new Date(year, now.getMonth() + 1, 0).toISOString().split('T')[0];

    const response = await fetch(`/api/student/${user.id}/attendance?from=${firstDay}&to=${lastDay}`);
    const data = await response.json();

    if (data.success) {
      displayAttendanceCalendar(data.attendanceRecords);
      updateAttendanceStats(data.summary);
    }
  } catch (error) {
    console.error('Error loading attendance:', error);
    displayAttendanceCalendar([]); // Show empty calendar on error
  }
}

function displayAttendanceCalendar(attendanceRecords) {
  const tbody = document.getElementById('attendanceTableBody');
  tbody.innerHTML = '';

  if (attendanceRecords.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No attendance records found for this month</td></tr>';
    return;
  }

  attendanceRecords.forEach(record => {
    const row = document.createElement('tr');
    const statusClass = record.status === 'present' ? 'present' : record.status === 'late' ? 'late' : 'absent';

    row.innerHTML = `
      <td>${new Date(record.date).toLocaleDateString()}</td>
      <td>${record.subject || 'N/A'}</td>
      <td><span class="attendance-status ${statusClass}">${record.status.charAt(0).toUpperCase() + record.status.slice(1)}</span></td>
      <td>${record.markedBy?.name || 'Admin'}</td>
    `;
    tbody.appendChild(row);
  });
}

function updateAttendanceStats(summary) {
  if (summary && summary.currentMonth) {
    document.getElementById('attendancePercentage').textContent = `${summary.currentMonth.percentage}%`;
    document.querySelector('.summary-card:nth-child(3) p.summary-value').textContent = summary.currentMonth.totalDays;
    document.querySelector('.summary-card:nth-child(2) p.summary-value').textContent = summary.currentMonth.presentDays;
    document.querySelector('.summary-card:nth-child(1) p.summary-value').textContent = summary.currentMonth.absentDays;
  }

  // Update overview stats
  if (summary.overall) {
    document.getElementById('attendancePercentage').textContent = `${summary.overall.percentage}%`;
  }
}

async function loadStudentResults() {
  try {
    const user = checkAuth();
    if (!user) return;

    const response = await fetch(`/api/student/${user.id}/results`);
    const data = await response.json();

    if (data.success) {
      displayResultsGrid(data.results);
      updateResultsStats(data.results);
    }
  } catch (error) {
    console.error('Error loading results:', error);
    displayResultsGrid([]); // Show empty results on error
  }
}

function displayResultsGrid(results) {
  const resultsGrid = document.getElementById('resultsGrid');
  resultsGrid.innerHTML = '';

  if (results.length === 0) {
    resultsGrid.innerHTML = '<div class="no-results">No results available yet. Check back later!</div>';
    return;
  }

  results.forEach(result => {
    const resultCard = document.createElement('div');
    resultCard.className = 'result-card';

    const gradeClass = result.grade === 'A' ? 'grade-a' :
                      result.grade === 'B' ? 'grade-b' :
                      result.grade === 'C' ? 'grade-c' : 'grade-d';

    resultCard.innerHTML = `
      <div class="result-header">
        <h4>${result.subject}</h4>
        <div class="result-meta">
          <span class="result-grade ${gradeClass}">${result.grade}</span>
          <span class="result-marks">${result.marks}/${result.maxMarks}</span>
        </div>
      </div>
      <div class="result-body">
        <p><strong>Date:</strong> ${new Date(result.postedAt).toLocaleDateString()}</p>
        <p><strong>Semester:</strong> ${result.semester || 'N/A'}</p>
        ${result.remarks ? `<p><strong>Remarks:</strong> ${result.remarks}</p>` : ''}
      </div>
    `;
    resultsGrid.appendChild(resultCard);
  });
}

function updateResultsStats(results) {
  if (results.length > 0) {
    // Calculate average grade
    const totalMarks = results.reduce((sum, r) => sum + (r.marks / r.maxMarks), 0);
    const avgGrade = totalMarks / results.length;

    let avgLetterGrade = 'A';
    if (avgGrade >= 90) avgLetterGrade = 'A';
    else if (avgGrade >= 80) avgLetterGrade = 'B';
    else if (avgGrade >= 70) avgLetterGrade = 'C';
    else if (avgGrade >= 60) avgLetterGrade = 'D';
    else avgLetterGrade = 'F';

    document.getElementById('averageGrade').textContent = avgLetterGrade;
    document.getElementById('pendingAssignments').textContent = results.length;
  }
}

async function loadStudentAssignments() {
  try {
    const user = checkAuth();
    if (!user) return;

    const response = await fetch(`/api/student/${user.id}/assignments`);
    const data = await response.json();

    if (data.success) {
      displayAssignmentsList(data.assignments);
      updateAssignmentStats(data.assignments);
    }
  } catch (error) {
    console.error('Error loading assignments:', error);
    displayAssignmentsList([]); // Show empty assignments on error
  }
}

function displayAssignmentsList(assignments) {
  const assignmentsList = document.getElementById('assignmentsList');
  assignmentsList.innerHTML = '';

  if (assignments.length === 0) {
    assignmentsList.innerHTML = '<div class="no-assignments">No assignments available at the moment.</div>';
    return;
  }

  assignments.forEach(assignment => {
    const assignmentDiv = document.createElement('div');
    assignmentDiv.className = 'assignment-item';

    const statusClass = assignment.submissionStatus === 'submitted' ? 'submitted' :
                         assignment.submissionStatus === 'graded' ? 'graded' : 'not_submitted';
    const deadlineClass = new Date(assignment.dueDate) < new Date() ? 'overdue' : 'on-time';

    assignmentDiv.innerHTML = `
      <div class="assignment-header">
        <h4>${assignment.title}</h4>
        <div class="assignment-meta">
          <span class="assignment-status ${statusClass}">${assignment.submissionStatus}</span>
          <span class="assignment-deadline ${deadlineClass}">Due: ${new Date(assignment.dueDate).toLocaleDateString()}</span>
        </div>
      </div>
      <div class="assignment-body">
        <p>${assignment.description}</p>
        <div class="assignment-info">
          <p><strong>Course:</strong> ${assignment.course}</p>
          ${assignment.branch ? `<p><strong>Branch:</strong> ${assignment.branch}</p>` : ''}
          ${assignment.yearOfStudy ? `<p><strong>Year:</strong> ${assignment.yearOfStudy}</p>` : ''}
        </div>
        ${assignment.attachments && assignment.attachments.length > 0 ? `
          <div class="assignment-attachments">
            <strong>Attachments:</strong>
            ${assignment.attachments.map(file =>
              `<a href="${file.storedPath}" target="_blank">${file.originalName}</a>`
            ).join(', ')}
          </div>
        ` : ''}
      </div>
      <div class="assignment-actions">
        ${assignment.submissionStatus === 'submitted' ? `
          <button class="btn btn-sm btn-warning" onclick="viewSubmissionDetails('${assignment._id}')">
            View Details
          </button>
        ` : ''}
        ${assignment.submissionStatus === 'graded' ? `
          <div class="graded-info">
            <p><strong>Grade:</strong> ${assignment.grade}</p>
            <p><strong>Feedback:</strong> ${assignment.feedback || 'No feedback provided'}</p>
          </div>
        ` : `
          <button class="btn btn-primary" onclick="submitAssignment('${assignment._id}')">
            Submit Assignment
          </button>
        `}
      </div>
    `;
    assignmentsList.appendChild(assignmentDiv);
  });
}

function updateAssignmentStats(assignments) {
  const total = assignments.length;
  const submitted = assignments.filter(a => a.submissionStatus === 'submitted' || a.submissionStatus === 'graded').length;
  const pending = total - submitted;

  document.getElementById('pendingAssignments').textContent = pending;
}

function viewSubmissionDetails(assignmentId) {
  showAssignmentModal(assignmentId);
}

function submitAssignment(assignmentId) {
  showAssignmentModal(assignmentId, true);
}

function showAssignmentModal(assignmentId, isSubmitting = false) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3>${isSubmitting ? 'Submit Assignment' : 'Assignment Details'}</h3>
        <button class="close-btn" onclick="closeModal(this.parentElement.parentElement.parentElement)">√ó</button>
      </div>
      <div class="modal-body">
        <div id="assignmentContent">
          Loading assignment details...
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.style.display = 'block';

  if (!isSubmitting) {
    // Load assignment details
    loadAssignmentDetails(assignmentId);
  } else {
    // Show submission form
    showAssignmentForm(assignmentId);
  }
}

async function loadAssignmentDetails(assignmentId) {
  try {
    const response = await fetch(`/api/assignment/${assignmentId}`);
    const data = await response.json();

    if (data.success) {
      const content = document.getElementById('assignmentContent');
      content.innerHTML = `
        <div class="assignment-details">
          <div class="assignment-overview">
            <h4>${data.title}</h4>
            <div class="assignment-meta">
              <p><strong>Course:</strong> ${data.course}</p>
              <p><strong>Branch:</strong> ${data.branch || 'All'}</p>
              <p><strong>Due Date:</strong> ${new Date(data.dueDate).toLocaleDateString()}</p>
              <p><strong>Status:</strong> <span class="assignment-status ${data.submissionStatus}">${data.submissionStatus}</span></p>
            </div>
            <div class="assignment-description">
              <p>${data.description}</p>
            </div>
            ${data.attachments && data.attachments.length > 0 ? `
              <div class="assignment-attachments">
                <h5>Attachments:</h5>
                ${data.attachments.map(file =>
                  `<div class="attachment-item">
                    <a href="${file.storedPath}" target="_blank">${file.originalName}</a>
                    <small>(${(file.size / 1024).toFixed(1)} KB)</small>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
          ${data.submissionStatus === 'graded' ? `
            <div class="graded-details">
              <h4>Graded Information</h4>
              <div class="grade-info">
                <p><strong>Grade:</strong> ${data.grade}</p>
                <p><strong>Feedback:</strong> ${data.feedback}</p>
                <p><strong>Graded by:</strong> ${data.postedBy?.name || 'Admin'}</p>
                <p><strong>Graded on:</strong> ${new Date(data.postedAt).toLocaleDateString()}</p>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }
  } catch (error) {
    const content = document.getElementById('assignmentContent');
    content.innerHTML = `
      <div class="error-message">
        <p>Failed to load assignment details</p>
        <button class="btn btn-secondary" onclick="closeModal(this.parentElement.parentElement.parentElement)">Close</button>
      </div>
    `;
  }
}

function showAssignmentForm(assignmentId) {
  const content = document.getElementById('assignmentContent');
  content.innerHTML = `
    <form id="assignmentSubmitForm">
      <div class="form-group">
        <label for="submissionRemarks">Remarks (optional):</label>
        <textarea id="submissionRemarks" rows="3" placeholder="Add any notes for the evaluator"></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Submit Assignment</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal(this.closest('.modal-overlay')">Cancel</button>
      </div>
    </form>
  `;

  // Handle form submission
  const form = document.getElementById('assignmentSubmitForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const currentUser = checkAuth();

    const submissionData = {
      assignmentId: assignmentId,
      remarks: formData.get('submissionRemarks'),
      studentId: currentUser.id
    };

    try {
      const response = await fetch('/api/student/assignment/submit', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(submissionData)
      });

      const data = await response.json();
      if (data.success) {
        showMessage('Assignment submitted successfully!', 'success');
        closeModal(modal);
        loadStudentAssignments(); // Refresh assignments list
      } else {
        showMessage(data.message || 'Failed to submit assignment', 'error');
      }
    } catch (error) {
      console.error('Error submitting assignment:', error);
      showMessage('Failed to submit assignment', 'error');
    }
  });
}

async function loadNotices() {
  try {
    const response = await fetch('/api/notices');
    const data = await response.json();

    if (data.success) {
      displayNotices(data.notices);
    }
  } catch (error) {
    console.error('Error loading notices:', error);
    displayNotices([]);
  }
}

function displayNotices(notices) {
  const noticesList = document.getElementById('noticesList');
  noticesList.innerHTML = '';

  if (notices.length === 0) {
    noticesList.innerHTML = '<div class="no-notices">No active notices at the moment.</div>';
    return;
  }

  notices.forEach(notice => {
    const noticeDiv = document.createElement('div');
    noticeDiv.className = 'notice-item';

    // Calculate remaining time
    const now = new Date();
    const expiresAt = new Date(notice.expiresAt);
    const remainingTime = Math.max(0, expiresAt - now);
    const hoursRemaining = Math.ceil(remainingTime / (1000 * 60 * 60));

    noticeDiv.innerHTML = `
      <div class="notice-header">
        <h4>${notice.title}</h4>
        <div class="notice-meta">
          <small class="notice-time">${new Date(notice.postedAt).toLocaleString()}</small>
          ${hoursRemaining > 0 ? `<span class="notice-expiry">(${hoursRemaining}h remaining)</span>` : ''}
        </div>
      </div>
      <div class="notice-content">
        ${notice.message}
      </div>
    `;

    noticesList.appendChild(noticeDiv);
  });
}

// Contact admin functionality
function messageAdmin() {
  showContactModal();
}

function showContactModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3>Message Administrator</h3>
        <button class="close-btn" onclick="closeModal(this.parentElement.parentElement)">√ó</button>
      </div>
      <div class="modal-body">
        <form id="contactForm">
          <div class="form-group">
            <label for="subject">Subject:</label>
            <input type="text" id="subject" required maxlength="100">
          </div>
          <div class="form-group">
            <label for="message">Message:</label>
            <textarea id="message" rows="5" required placeholder="Describe your message here..."></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Send Message</button>
            <button type="button" class="btn btn-secondary" onclick="closeModal(this.parentElement.parentElement)">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.style.display = 'block';

  // Handle form submission
  const form = document.getElementById('contactForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const currentUser = checkAuth();

    const contactData = {
      fromStudent: currentUser.id,
      subject: formData.get('subject'),
      message: formData.get('message')
    };

    try {
      const response = await fetch('/api/contact/admin', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(contactData)
      });

      const data = await response.json();
      if (data.success) {
        showMessage('Message sent to administrator successfully!', 'success');
        closeModal(modal);
      } else {
        showMessage('Failed to send message. Please try again.', 'error');
      }
    } catch (error) {
      console.error('Error sending contact message:', error);
      showMessage('Failed to send message. Please try again.', 'error');
    }
  });
}

// QR Code generation
function showQRCode() {
  const user = checkAuth();
  if (!user) return;

  generateStudentQR(user.id);
}

async function generateStudentQR(studentId) {
  try {
    const response = await fetch(`/api/student/${studentId}/qr`);
    const data = await response.json();

    if (data.success) {
      showQRModal(data.qrUrl);
    } else {
      showMessage('Failed to generate QR code', 'error');
    }
  } catch (error) {
    console.error('Error generating QR code:', error);
    showMessage('Failed to generate QR code', 'error');
  }
}

function showQRModal(qrUrl) {
  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content qr-modal">
      <div class="modal-header">
        <h3>Your QR Code</h3>
        <button class="close-btn" onclick="closeModal(this.parentElement.parentElement)">&times;</button>
      </div>
      <div class="modal-body">
        <div class="qr-display">
          <img src="${qrUrl}" alt="Student QR Code" style="max-width: 300px; border: 2px solid #ddd; border-radius: 8px;" />
        </div>
        <div class="qr-info">
          <p>This QR code is unique to your student account.</p>
          <p>Present this QR code for attendance marking.</p>
        </div>
        <div class="qr-actions">
          <button class="btn btn-primary" onclick="downloadQR('${qrUrl}')">
            üì• Download QR Code
          </button>
          <button class="btn btn-secondary" onclick="closeModal(this.parentElement.parentElement)">Close</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.style.display = 'block';
}

function downloadQR(qrUrl) {
  const link = document.createElement('a');
  link.href = qrUrl;
  link.download = 'student-qr-code.png';
  link.click();
}

// Chat functionality
function openChatWithAdmin() {
  const user = checkAuth();
  if (!user) return;

  openChatModal('admin', user.id);
}

function openChatModal(otherUserId, studentId = null) {
  // This will be used when the chat feature is implemented
  console.log('Chat feature will open with:', otherUserId);
  showMessage('Chat feature will be available soon!', 'info');
}

// Admin messaging
function showChatModal(chatId, otherUserId) {
  currentChatId = chatId;
  const modal = document.createElement('div');
  modal.className = 'modal-overlay chat-modal';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3>Chat</h3>
        <button class="close-btn" onclick="closeModal(this.parentElement.parentElement)">&times;</button>
      </div>
      <div class="modal-body">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
          <div class="input-group">
            <input type="text" id="messageInput" placeholder="Type a message..." />
            <button id="sendMessageBtn">Send</button>
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.style.display = 'block';

  // Initialize chat
  initChat(chatId);
  loadChatMessages(chatId);

  // Add send button functionality
  const sendBtn = document.getElementById('sendMessageBtn');
  sendBtn.addEventListener('click', sendMessage);

  // Message input functionality
  const messageInput = document.getElementById('messageInput');
  messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });
}

async function initChat(chatId) {
  // Initialize Socket.IO if available
  if (typeof io !== 'undefined') {
    socket = io();

    socket.on('connect', () => {
      socket.emit('joinChat', { chatId, userId: checkAuth().id });
    });

    socket.on('joinedChat', (data) => {
      console.log('Joined chat:', data);
    });

    socket.on('message:new', (message) => {
      displayMessage(message);
    });

    socket.on('message:read', (data) => {
      markMessagesAsRead(data.messageIds, checkAuth().id);
    });
  }
}

async function loadChatMessages(chatId) {
  try {
    const currentUser = checkAuth();
    const response = await fetch(`/api/chat/${chatId}/messages?currentUserId=${currentUser.id}&page=1&limit=50`);
    const data = await response.json();

    if (data.success) {
      displayMessages(data.messages);
    }
  } catch (error) {
    console.error('Error loading chat messages:', error);
    displayMessages([]);
  }
}

function displayMessages(messages) {
  const messagesContainer = document.getElementById('chatMessages');
  messagesContainer.innerHTML = '';

  messages.forEach(message => {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-item ${message.from === checkAuth().id ? 'sent' : 'received'}`;
    messageDiv.innerHTML = `
      <div class="message-header">
        <strong>${message.from.name}</strong>
        <small>${new Date(message.sentAt).toLocaleTimeString()}</small>
      </div>
      <div class="message-content">
        ${message.text}
      </div>
    `;
    messagesContainer.appendChild(messageDiv);
  });

  // Scroll to bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();

  if (!text) return;

  const currentUser = checkAuth();
  const chatId = currentChatId;

  if (socket) {
    // Send via WebSocket
    socket.emit('message:new', {
      chatId,
      from: currentUser.id,
      to: 'otherUserId',
      text: text
    });
  } else {
    // Fallback to HTTP API
    showMessage('Real-time chat requires Socket.IO', 'info');
  }

  input.value = '';
}

function displayMessage(message) {
  const messagesContainer = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `message-item ${message.from === checkAuth().id ? 'sent' : 'received'}`;
  messageDiv.innerHTML = `
    <div class="message-header">
      <strong>${message.from.name}</strong>
      <small>${new Date(message.sentAt).toLocaleTimeString()}</small>
    </div>
    <div class="message-content">
      ${message.text}
    </div>
  `;
  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function markMessagesAsRead(messageIds, userId) {
  // Mark messages as read
  // This is already implemented in the server-side
  console.log('Marking messages as read:', messageIds);
}

// Update overview stats
async function updateDashboardStats() {
  try {
    const user = checkAuth();
    if (!user) return;

    // Get attendance summary
    const attendanceResponse = await fetch(`/api/student/${user.id}/attendance/summary`);
    const attendanceData = await attendanceResponse.json();

    // Get results summary
    const resultsResponse = await fetch(`/api/student/${user.id}/results`);
    const resultsData = await resultsResponse.json();

    // Get assignments summary
    const assignmentsResponse = await fetch(`/api/student/${user.id}/assignments`);
    const assignmentsData = await assignmentsResponse.json();

    // Update UI
    if (attendanceData.success) {
      updateAttendanceStats(attendanceData.summary);
    }

    if (resultsData.success) {
      updateResultsStats(resultsData.results);
    }

    if (assignmentsData.success) {
      updateAssignmentStats(assignmentsData.assignments);
    }

    // Get active notices
    const noticesResponse = fetch('/api/notices');
    const noticesData = await noticesResponse.json();

    if (noticesData.success) {
      updateNoticesCount(noticesData.notices.length);
    }

  } catch (error) {
    console.error('Error updating dashboard stats:', error);
  }
}

function updateNoticesCount(noticesCount) {
  document.getElementById('unreadNotices').textContent = noticesCount;
}

// Helper function to get the current logged-in user
function checkAuth() {
  const user = localStorage.getItem("user");
  if (!user) {
    window.location.href = "./stu_login.html";
    return null;
  }
  return JSON.parse(user);
}

function editProfile() {
  document.getElementById('profileForm').style.display = 'block';
  document.getElementById('profileDisplay').style.display = 'none';
  currentStep = 1;
  showStep(1);
  updateButtonVisibility();
}

function closeModal(element) {
  const modal = element.closest('.modal-overlay');
  if (modal && modal.parentNode) {
    modal.parentNode.removeChild(modal);
  }
}
function logout() { localStorage.removeItem("user"); window.location.href = "./stu_login.html"; }

function showMessage(message, type) {
  const messageDiv = document.getElementById(type === "success" ? "successMessage" : "errorMessage");
  messageDiv.textContent = message;
  messageDiv.style.display = "block";
  setTimeout(() => { messageDiv.style.display = "none"; }, 3000);
}

/* ==========================
   MULTI-STEP FORM
   ========================== */

let currentStep = 1;
const totalSteps = 3;

function setupMultiStepForm() {
  const nextBtn = document.getElementById('nextBtn');
  const prevBtn = document.getElementById('prevBtn');
  const submitBtn = document.getElementById('submitBtn');

  nextBtn.addEventListener('click', nextStep);
  prevBtn.addEventListener('click', prevStep);
  submitBtn.addEventListener('click', submitProfile);

  updateButtonVisibility();
}

function nextStep() {
  if (validateCurrentStep()) {
    if (currentStep < totalSteps) {
      currentStep++;
      showStep(currentStep);
      updateButtonVisibility();
    }
  }
}

function prevStep() {
  if (currentStep > 1) {
    currentStep--;
    showStep(currentStep);
    updateButtonVisibility();
  }
}

function showStep(step) {
  document.querySelectorAll('.form-step').forEach(stepEl => stepEl.classList.remove('active'));
  document.querySelector(`[data-step="${step}"]`).classList.add('active');

  document.querySelectorAll('.step').forEach((stepEl, index) => {
    stepEl.classList.remove('active');
    if (index + 1 <= step) stepEl.classList.add('active');
  });
}

function updateButtonVisibility() {
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const submitBtn = document.getElementById('submitBtn');

  prevBtn.style.display = currentStep > 1 ? 'block' : 'none';
  nextBtn.style.display = currentStep < totalSteps ? 'block' : 'none';
  submitBtn.style.display = currentStep === totalSteps ? 'block' : 'none';
}

function validateCurrentStep() {
  const currentStepEl = document.querySelector(`[data-step="${currentStep}"]`);
  const requiredFields = currentStepEl.querySelectorAll('[required]');

  for (let field of requiredFields) {
    if (!field.value.trim()) {
      showMessage(`Please fill in ${field.previousElementSibling.textContent}`, 'error');
      field.focus();
      return false;
    }
  }
  return true;
}

async function submitProfile(e) {
  e.preventDefault();
  if (!validateCurrentStep()) return;
  const user = checkAuth();
  if (!user) return;

  // Collect form data
  const personalInfo = {
    fullName: document.getElementById('fullName').value,
    age: parseInt(document.getElementById('age').value),
    gender: document.getElementById('gender').value,
    email: document.getElementById('email').value,
    phone: document.getElementById('phone').value,
    whatsapp: document.getElementById('whatsapp').value
  };
  const academicInfo = {
    registrationNo: document.getElementById('registrationNo').value,
    branch: document.getElementById('branch').value,
    yearOfStudy: parseInt(document.getElementById('yearOfStudy').value),
    section: document.getElementById('section').value
  };
  const professionalInfo = {
    role: document.getElementById('role').value,
    skills: document.getElementById('skills').value
  };

  const profileData = {
    personalInfo,
    academicInfo,
    professionalInfo
  };

  // Get files
  const profilePictureFile = document.getElementById('profilePicture').files[0];
  const resumeFile = document.getElementById('resumeFile').files[0];

  // Check if online
  if (isOnline) {
    // Try to submit directly to server
    try {
      showMessage('Saving profile...', 'success');
      const formData = new FormData();
      formData.append('studentId', user.id);
      formData.append('personalInfo', JSON.stringify(personalInfo));
      formData.append('academicInfo', JSON.stringify(academicInfo));
      formData.append('professionalInfo', JSON.stringify(professionalInfo));

      if (profilePictureFile) formData.append('profilePicture', profilePictureFile);
      if (resumeFile) formData.append('resumeFile', resumeFile);

      const response = await fetch('/api/student/profile', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();

      if (data.success) {
        showMessage('Profile completed successfully!', 'success');
        document.getElementById('profileForm').style.display = 'none';
        document.getElementById('profileDisplay').style.display = 'block';
        loadProfileData(user);
        // Clear localStorage form data
        localStorage.removeItem('multiStepFormData');
      } else {
        // If server fails, save offline
        showMessage(data.message || 'Server error. Saving offline...', 'error');
        saveProfileForOffline(profileData, { profilePictureFile, resumeFile }, user);
      }
    } catch (error) {
      console.error('Profile submission error:', error);
      showMessage('Network error. Saving profile offline...', 'error');
      saveProfileForOffline(profileData, { profilePictureFile, resumeFile }, user);
    }
  } else {
    // Offline mode - save locally
    showMessage('Working offline. Profile will be saved locally and synced when online.', 'info');
    saveProfileForOffline(profileData, { profilePictureFile, resumeFile }, user);
  }
}

// Save profile for offline sync
function saveProfileForOffline(profileData, files, user) {
  const filesForOffline = {};

  // Save files to IndexedDB if they exist
  if (files.profilePictureFile) {
    saveFileOffline('profilePicture');
    filesForOffline.profilePicture = files.profilePictureFile;
  }
  if (files.resumeFile) {
    saveFileOffline('resumeFile');
    filesForOffline.resumeFile = files.resumeFile;
  }

  // Save profile data for offline sync
  saveProfileOffline(profileData, filesForOffline);

  // Hide form and show completion message
  document.getElementById('profileForm').style.display = 'none';
  document.getElementById('profileDisplay').style.display = 'block';

  // Show offline completion message in profile display
  const profileDetails = document.getElementById('profileDetails');
  profileDetails.innerHTML = `
    <div class="profile-section">
      <h3>Profile Saved Offline</h3>
      <div class="profile-info">
        <p><strong>Status:</strong> <span style="color: #ff9800;">‚è≥ Pending Sync</span></p>
        <p>Your profile has been saved locally and will be automatically synced when you're back online.</p>
        <div style="margin-top: 15px;">
          <p><strong>Name:</strong> ${profileData.personalInfo.fullName}</p>
          <p><strong>Email:</strong> ${profileData.personalInfo.email}</p>
          <p><strong>Registration No:</strong> ${profileData.academicInfo.registrationNo}</p>
          <p><strong>Branch:</strong> ${profileData.academicInfo.branch}</p>
        </div>
      </div>
    </div>
  `;

  // Show edit button for manual retry
  const editBtn = document.querySelector('.change-photo-btn');
  if (editBtn) {
    editBtn.textContent = 'Edit Profile / Retry Sync';
    editBtn.onclick = () => {
      document.getElementById('profileForm').style.display = 'block';
      document.getElementById('profileDisplay').style.display = 'none';
      currentStep = 1;
      showStep(1);
      updateButtonVisibility();
    };
  }
}

async function loadProfileData(user) {
  try {
    const response = await fetch(`/api/student/profile/${user.id}`);
    const data = await response.json();
    if (data.success && data.profile) displayProfileData(data.profile);
  } catch (error) { console.error('Error loading profile:', error); }
}

function displayProfileData(profile) {
  const profileDetails = document.getElementById('profileDetails');
  const profileImage = document.getElementById('profileImage');
  if (profile.personalInfo.profilePicture) profileImage.src = profile.personalInfo.profilePicture;

  profileDetails.innerHTML = `
    <div class="profile-section">
      <h3>Personal Information</h3>
      <div class="profile-info">
        <p><strong>Name:</strong> ${profile.personalInfo.fullName}</p>
        <p><strong>Age:</strong> ${profile.personalInfo.age}</p>
        <p><strong>Gender:</strong> ${profile.personalInfo.gender}</p>
        <p><strong>Email:</strong> ${profile.personalInfo.email}</p>
        <p><strong>Phone:</strong> ${profile.personalInfo.phone}</p>
        <p><strong>WhatsApp:</strong> ${profile.personalInfo.whatsapp}</p>
      </div>
    </div>
    <div class="profile-section">
      <h3>Academic Information</h3>
      <div class="profile-info">
        <p><strong>Registration No:</strong> ${profile.academicInfo.registrationNo}</p>
        <p><strong>Branch:</strong> ${profile.academicInfo.branch}</p>
        <p><strong>Year:</strong> ${profile.academicInfo.yearOfStudy}</p>
        <p><strong>Section:</strong> ${profile.academicInfo.section}</p>
      </div>
    </div>
    ${profile.professionalInfo.role || profile.professionalInfo.skills ? `
    <div class="profile-section">
      <h3>Professional Information</h3>
      <div class="profile-info">
        ${profile.professionalInfo.role ? `<p><strong>Role:</strong> ${profile.professionalInfo.role}</p>` : ''}
        ${profile.professionalInfo.skills ? `<p><strong>Skills:</strong> ${profile.professionalInfo.skills}</p>` : ''}
        ${profile.professionalInfo.resumeFile ? `<p><strong>Resume:</strong> <a href="${profile.professionalInfo.resumeFile}" target="_blank">View Resume</a></p>` : ''}
      </div>
    </div>
    ` : ''}
  `;
}

function editProfile() {
  document.getElementById('profileForm').style.display = 'block';
  document.getElementById('profileDisplay').style.display = 'none';
  currentStep = 1;
  showStep(1);
  updateButtonVisibility();
}

/* ==========================
   LOCALSTORAGE AUTO-SAVE
   ========================== */

const form = document.getElementById('multiStepForm');
form.addEventListener('input', () => {
  const formData = {
    personalInfo: {
      fullName: document.getElementById('fullName')?.value || '',
      age: document.getElementById('age')?.value || '',
      gender: document.getElementById('gender')?.value || '',
      email: document.getElementById('email')?.value || '',
      phone: document.getElementById('phone')?.value || '',
      whatsapp: document.getElementById('whatsapp')?.value || ''
    },
    academicInfo: {
      registrationNo: document.getElementById('registrationNo')?.value || '',
      branch: document.getElementById('branch')?.value || '',
      yearOfStudy: document.getElementById('yearOfStudy')?.value || '',
      section: document.getElementById('section')?.value || ''
    },
    professionalInfo: {
      role: document.getElementById('role')?.value || '',
      skills: document.getElementById('skills')?.value || ''
    }
  };
  localStorage.setItem('multiStepFormData', JSON.stringify(formData));
});

function loadSavedFormData() {
  const savedData = JSON.parse(localStorage.getItem('multiStepFormData'));
  if (!savedData) return;

  for (const section in savedData) {
    for (const key in savedData[section]) {
      const input = document.getElementById(key);
      if (input) input.value = savedData[section][key];
    }
  }
}

/* ==========================
   OFFLINE SYNC SYSTEM
   ========================== */

let profileDB;
let isOnline = navigator.onLine;
let syncInProgress = false;

// Initialize IndexedDB for offline storage
function initOfflineDB() {
  const request = indexedDB.open('StudentOfflineData', 2);

  request.onerror = (event) => {
    console.error('IndexedDB error:', event.target.error);
  };

  request.onupgradeneeded = (event) => {
    profileDB = event.target.result;

    // Create object stores
    if (!profileDB.objectStoreNames.contains('pendingProfiles')) {
      profileDB.createObjectStore('pendingProfiles', { keyPath: 'id' });
    }
    if (!profileDB.objectStoreNames.contains('files')) {
      profileDB.createObjectStore('files', { keyPath: 'id' });
    }
  };

  request.onsuccess = (event) => {
    profileDB = event.target.result;
    console.log('Offline database initialized');

    // Setup file storage for form inputs
    ['profilePicture', 'resumeFile'].forEach(id => {
      const input = document.getElementById(id);
      if (input) {
        input.addEventListener('change', () => saveFileOffline(id));
      }
    });

    // Check for pending profiles and try to sync
    checkAndSyncPendingProfiles();
  };
}

// Save file to IndexedDB
function saveFileOffline(fileInputId) {
  const fileInput = document.getElementById(fileInputId);
  const file = fileInput.files[0];
  if (!file || !profileDB) return;

  const transaction = profileDB.transaction(['files'], 'readwrite');
  const store = transaction.objectStore('files');

  const fileData = {
    id: fileInputId,
    file: file,
    name: file.name,
    type: file.type,
    size: file.size,
    lastModified: file.lastModified
  };

  store.put(fileData);

  transaction.oncomplete = () => {
    console.log(`${fileInputId} saved in IndexedDB for offline use`);
  };

  transaction.onerror = (error) => {
    console.error('Error saving file to IndexedDB:', error);
  };
}

// Load file from IndexedDB
function loadFileOffline(fileInputId, callback) {
  if (!profileDB) return;

  const transaction = profileDB.transaction(['files'], 'readonly');
  const store = transaction.objectStore('files');
  const request = store.get(fileInputId);

  request.onsuccess = () => {
    if (request.result) {
      callback(request.result.file);
    }
  };

  request.onerror = (error) => {
    console.error('Error loading file from IndexedDB:', error);
  };
}

// Save profile data for offline sync
function saveProfileOffline(profileData, files = {}) {
  if (!profileDB) return;

  const user = checkAuth();
  if (!user) return;

  const transaction = profileDB.transaction(['pendingProfiles'], 'readwrite');
  const store = transaction.objectStore('pendingProfiles');

  const pendingProfile = {
    id: `temp-${user.id}-${Date.now()}`,
    userId: user.id,
    profileData: profileData,
    files: files,
    timestamp: Date.now(),
    syncAttempts: 0
  };

  store.put(pendingProfile);

  transaction.oncomplete = () => {
    console.log('Profile saved for offline sync:', pendingProfile.id);
    showSyncStatus('Profile saved locally. Will sync when online.');
  };

  transaction.onerror = (error) => {
    console.error('Error saving profile for offline sync:', error);
  };
}

// Check and sync pending profiles
async function checkAndSyncPendingProfiles() {
  if (!profileDB || !isOnline || syncInProgress) return;

  syncInProgress = true;

  try {
    const transaction = profileDB.transaction(['pendingProfiles'], 'readonly');
    const store = transaction.objectStore('pendingProfiles');
    const request = store.getAll();

    request.onsuccess = async () => {
      const pendingProfiles = request.result;

      if (pendingProfiles.length === 0) {
        syncInProgress = false;
        return;
      }

      console.log(`Found ${pendingProfiles.length} pending profiles to sync`);
      showSyncStatus(`Syncing ${pendingProfiles.length} profile(s)...`);

      for (const pendingProfile of pendingProfiles) {
        await syncSingleProfile(pendingProfile);
      }

      syncInProgress = false;
    };

    request.onerror = (error) => {
      console.error('Error checking pending profiles:', error);
      syncInProgress = false;
    };
  } catch (error) {
    console.error('Error in sync process:', error);
    syncInProgress = false;
  }
}

// Sync a single profile to server
async function syncSingleProfile(pendingProfile) {
  try {
    const user = checkAuth();
    if (!user) return;

    const formData = new FormData();
    formData.append('studentId', user.id);

    // Add profile data
    formData.append('personalInfo', JSON.stringify(pendingProfile.profileData.personalInfo));
    formData.append('academicInfo', JSON.stringify(pendingProfile.profileData.academicInfo));
    formData.append('professionalInfo', JSON.stringify(pendingProfile.profileData.professionalInfo));

    // Add files if they exist
    if (pendingProfile.files.profilePicture) {
      formData.append('profilePicture', pendingProfile.files.profilePicture);
    }
    if (pendingProfile.files.resumeFile) {
      formData.append('resumeFile', pendingProfile.files.resumeFile);
    }

    const response = await fetch('/api/student/profile', {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      // Remove from pending profiles after successful sync
      const transaction = profileDB.transaction(['pendingProfiles'], 'readwrite');
      const store = transaction.objectStore('pendingProfiles');
      store.delete(pendingProfile.id);

      console.log(`Profile ${pendingProfile.id} synced successfully`);
      showSyncStatus('Profile synced successfully!', 'success');
    } else {
      throw new Error('Server rejected profile sync');
    }
  } catch (error) {
    console.error('Error syncing profile:', pendingProfile.id, error);

    // Increment sync attempts and remove if too many failed attempts
    pendingProfile.syncAttempts++;

    if (pendingProfile.syncAttempts >= 3) {
      // Remove after 3 failed attempts
      const transaction = profileDB.transaction(['pendingProfiles'], 'readwrite');
      const store = transaction.objectStore('pendingProfiles');
      store.delete(pendingProfile.id);

      showSyncStatus('Failed to sync profile after multiple attempts. Please try again.', 'error');
    } else {
      // Update sync attempts
      const transaction = profileDB.transaction(['pendingProfiles'], 'readwrite');
      const store = transaction.objectStore('pendingProfiles');
      store.put(pendingProfile);
    }
  }
}

// Network detection
function setupNetworkDetection() {
  // Listen for online/offline events
  window.addEventListener('online', () => {
    isOnline = true;
    console.log('Network connection restored');
    showSyncStatus('Connection restored. Checking for pending sync...', 'success');
    checkAndSyncPendingProfiles();
    updateSyncIndicator();
  });

  window.addEventListener('offline', () => {
    isOnline = false;
    console.log('Network connection lost');
    showSyncStatus('Connection lost. Working in offline mode.', 'error');
    updateSyncIndicator();
  });

  // Periodic sync check (every 30 seconds)
  setInterval(() => {
    if (isOnline && !syncInProgress) {
      checkAndSyncPendingProfiles();
    }
    updateSyncIndicator();
  }, 30000);
}

// Show sync status to user
function showSyncStatus(message, type = 'info') {
  // Create or update sync status indicator
  let statusIndicator = document.getElementById('syncStatus');

  if (!statusIndicator) {
    statusIndicator = document.createElement('div');
    statusIndicator.id = 'syncStatus';
    statusIndicator.className = 'sync-status';
    document.body.appendChild(statusIndicator);
  }

  statusIndicator.textContent = message;
  statusIndicator.className = `sync-status ${type}`;
  statusIndicator.style.display = 'block';

  // Auto-hide after 5 seconds for success/info messages
  if (type === 'success' || type === 'info') {
    setTimeout(() => {
      statusIndicator.style.display = 'none';
    }, 5000);
  }
}

// Update sync indicator in UI
function updateSyncIndicator() {
  let indicator = document.getElementById('syncIndicator');

  if (!indicator) {
    indicator = document.createElement('div');
    indicator.id = 'syncIndicator';
    indicator.className = 'sync-indicator';
    document.querySelector('.header-right').appendChild(indicator);
  }

  if (!isOnline) {
    indicator.innerHTML = 'üî¥ Offline';
    indicator.title = 'Working offline. Data will sync when connection is restored.';
    indicator.className = 'sync-indicator offline';
  } else if (syncInProgress) {
    indicator.innerHTML = 'üîÑ Syncing...';
    indicator.title = 'Syncing data to server...';
    indicator.className = 'sync-indicator syncing';
  } else {
    indicator.innerHTML = 'üü¢ Online';
    indicator.title = 'All data synced';
    indicator.className = 'sync-indicator online';
  }
}

/* ==========================
   INDEXEDDB FILE STORAGE (LEGACY)
   ========================== */

let db;
const request = indexedDB.open('StudentData', 1);

request.onupgradeneeded = function(e) {
  db = e.target.result;
  if (!db.objectStoreNames.contains('files')) db.createObjectStore('files', { keyPath: 'name' });
};

request.onsuccess = function(e) {
  db = e.target.result;
  ['profilePicture','resumeFile'].forEach(id => {
    const input = document.getElementById(id);
    if (input) input.addEventListener('change', () => saveFile(id));
  });
};

request.onerror = function(e) { console.error('IndexedDB error:', e); };

function saveFile(fileInputId) {
  const fileInput = document.getElementById(fileInputId);
  const file = fileInput.files[0];
  if (!file || !db) return;

  const transaction = db.transaction(['files'], 'readwrite');
  const store = transaction.objectStore('files');
  store.put({ name: fileInputId, file });

  transaction.oncomplete = () => console.log(`${fileInputId} saved in IndexedDB`);
}

function loadFile(fileInputId, callback) {
  if (!db) return;
  const transaction = db.transaction(['files'], 'readonly');
  const store = transaction.objectStore('files');
  const request = store.get(fileInputId);

  request.onsuccess = () => {
    if (request.result) callback(request.result.file);
  };
}

/* ==========================
   DOMContentLoaded INIT
   ========================== */

document.addEventListener('DOMContentLoaded', () => {
  initDashboard();
  setupNavigation();
  setupMultiStepForm();
  loadSavedFormData();

  // Initialize offline sync system
  initOfflineDB();
  setupNetworkDetection();
  updateSyncIndicator();
});
</script>

  </body>
</html>

