<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Signup</title>
    <!-- ADD THESE THREE LINES FOR THE NEW FONT -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="./style.css" />
    <link rel="stylesheet" href="./studentsignup.css" />
  </head>
  <body>
    <div class="container">
      <div class="login-left">
        <h1>Create Your Account</h1>
        <p class="subtitle">
          Join us and access your student portal instantly.
        </p>

        <form id="signupForm" onsubmit="return false;">
          <!-- Step 1: Email Input -->
          <div id="emailSection">
            <input
              type="email"
              id="email"
              name="email"
              placeholder="Enter your email"
              required
            />
            <button type="button" id="sendOtpBtn">
              <span class="button-text">Send OTP</span>
              <div class="spinner"></div>
            </button>
          </div>

          <!-- Step 2: OTP Verification -->
          <div id="otpSection" style="display: none">
            <input
              type="text"
              id="otp"
              name="otp"
              placeholder="Enter OTP"
              required
            />
            <button type="button" id="verifyOtpBtn">
              <span class="button-text">Verify OTP</span>
              <div class="spinner"></div>
            </button>
          </div>

          <!-- Step 3: Registration Details -->
          <div id="registerSection" style="display: none">
            <input
              type="text"
              id="name"
              name="name"
              placeholder="Full Name"
              required
            />
            <input
              type="password"
              id="password"
              name="password"
              placeholder="Password"
              required
            />
            <input
              type="password"
              id="confirm-password"
              name="confirmPassword"
              placeholder="Confirm Password"
              required
            />
            <button type="button" id="signupBtn">
              <span class="button-text">Sign Up</span>
              <div class="spinner"></div>
            </button>
          </div>

          <div class="error-message" id="errorMessage"></div>
          <div class="success-message" id="successMessage"></div>
          <p class="alt-link">
            Already have an account? <a href="/student-login.html">Log in</a>
          </p>
        </form>
      </div>

      <div class="login-right">
        <img
          src="https://storage.googleapis.com/pixelverse-public/ai-images/2024-03-08/1709880921_9999_development.png"
          alt="Student Signup Illustration"
        />
      </div>
    </div>

    <script>
      const emailSection = document.getElementById("emailSection");
      const otpSection = document.getElementById("otpSection");
      const registerSection = document.getElementById("registerSection");
      const sendOtpBtn = document.getElementById("sendOtpBtn");
      const verifyOtpBtn = document.getElementById("verifyOtpBtn");
      const signupBtn = document.getElementById("signupBtn");
      const errorMessage = document.getElementById("errorMessage");
      const successMessage = document.getElementById("successMessage");

      let verifiedEmail = null;

      // --- Helper to display clear errors ---
      function showError(message) {
        successMessage.textContent = "";
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
      }

      // 1. Send OTP - UPDATED
      sendOtpBtn.onclick = async function () {
        const email = document.getElementById("email").value;
        if (!email) {
          showError("Please enter an email address.");
          return;
        }

        sendOtpBtn.disabled = true;
        sendOtpBtn.classList.add("loading");
        errorMessage.style.display = "none";
        successMessage.textContent = "Checking email...";

        const res = await fetch("http://localhost:3001/api/send-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });

        const data = await res.json();
        sendOtpBtn.disabled = false;
        sendOtpBtn.classList.remove("loading");

        if (res.ok) {
          successMessage.textContent = "OTP sent to your email!";
          emailSection.style.display = "none";
          otpSection.style.display = "block";
        } else {
          // Check for our custom 'userExists' flag
          if (data.userExists) {
            showError(data.message);
          } else {
            showError(data.message || "Failed to send OTP.");
          }
        }
      };

      // 2. Verify OTP - UPDATED
      verifyOtpBtn.onclick = async function () {
        const email = document.getElementById("email").value;
        const otp = document.getElementById("otp").value;
        if (!otp) {
          showError("Please enter the OTP.");
          return;
        }

        verifyOtpBtn.disabled = true;
        verifyOtpBtn.classList.add("loading");
        errorMessage.style.display = "none";
        successMessage.textContent = "Verifying...";

        const res = await fetch("http://localhost:3001/api/verify-otp", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, otp }),
        });

        const data = await res.json();
        verifyOtpBtn.disabled = false;
        verifyOtpBtn.classList.remove("loading");

        if (res.ok) {
          verifiedEmail = email;
          successMessage.textContent =
            "OTP Verified! Please complete your registration.";
          otpSection.style.display = "none";
          registerSection.style.display = "block";
        } else {
          showError(data.message || "Invalid or expired OTP.");
        }
      };

      // 3. Register User
      signupBtn.onclick = async function () {
        const name = document.getElementById("name").value;
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirm-password").value;
        if (!verifiedEmail) {
          errorMessage.textContent = "Email not verified. Please start over.";
          return;
        }
        if (password !== confirmPassword) {
          errorMessage.textContent = "Passwords do not match.";
          return;
        }
        if (!name || !password) {
          errorMessage.textContent = "Name and password are required.";
          return;
        }

        signupBtn.disabled = true;
        signupBtn.classList.add("loading"); // Show spinner
        errorMessage.textContent = "";
        successMessage.textContent = "Processing...";
        successMessage.style.fontSize = "1.2em"; // Make message bigger
        errorMessage.style.fontSize = "1.2em"; // Make message bigger

        try {
          const res = await fetch("http://localhost:3001/api/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email: verifiedEmail, password }),
          });
          if (res.ok) {
            successMessage.textContent =
              "User Registered Successfully! Redirecting to login...";
            setTimeout(() => {
              window.location.href = "/student-login.html";
            }, 2500);
          } else if (res.status === 409) {
            errorMessage.textContent =
              "User already exists. Redirecting to login...";
            successMessage.textContent = "";
            setTimeout(() => {
              window.location.href = "/student-login.html";
            }, 2500);
          } else {
            const data = await res.json();
            errorMessage.textContent = data.message || "Registration failed.";
            successMessage.textContent = "";
            signupBtn.disabled = false;
            signupBtn.classList.remove("loading"); // Hide spinner on failure
          }
        } catch (error) {
          errorMessage.textContent = "A network error occurred.";
          successMessage.textContent = "";
          signupBtn.disabled = false;
          signupBtn.classList.remove("loading"); // Hide spinner on failure
        }
      };
    </script>
  </body>
</html>
